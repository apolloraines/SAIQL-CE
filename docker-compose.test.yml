version: '3.8'

services:
  # PostgreSQL Test Database
  postgres-test:
    image: postgres:15-alpine
    container_name: saiql-postgres-test
    environment:
      POSTGRES_DB: saiql_test
      POSTGRES_USER: saiql_test_user
      POSTGRES_PASSWORD: saiql_test_password_123
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./tests/database/init-postgres.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saiql_test_user -d saiql_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - saiql-test-network

  # MySQL Test Database
  mysql-test:
    image: mysql:8.0
    container_name: saiql-mysql-test
    environment:
      MYSQL_DATABASE: saiql_test
      MYSQL_USER: saiql_test_user
      MYSQL_PASSWORD: saiql_test_password_123
      MYSQL_ROOT_PASSWORD: saiql_root_password_123
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "3307:3306"
    volumes:
      - mysql_test_data:/var/lib/mysql
      - ./tests/database/init-mysql.sql:/docker-entrypoint-initdb.d/01-init.sql
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=256M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "saiql_test_user", "-psaiql_test_password_123"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - saiql-test-network

  # ChromaDB for Vector Testing
  chromadb-test:
    image: chromadb/chroma:latest
    container_name: saiql-chromadb-test
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_PORT=8000
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    ports:
      - "8001:8000"
    volumes:
      - chromadb_test_data:/chroma/chroma
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - saiql-test-network

  # Redis for Caching Tests
  redis-test:
    image: redis:7-alpine
    container_name: saiql-redis-test
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --maxmemory 256mb
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - saiql-test-network

volumes:
  postgres_test_data:
  mysql_test_data:
  chromadb_test_data:
  redis_test_data:

networks:
  saiql-test-network:‍‍‍‌‍‍‌‌​‌‍‌‍‌‌‍‌​‌‍‌‍‌‌‌‌​‍‍‌‍‍‍‍‌​‍‍‌‍‍‍‍‍​‌‍‌‍‌‍‍‌​‍‍‌‌‍‍‍‌​‌‍‍‌‍‌‍‍​‌‌‌‌‌‌‌‌​‍‌‌‌‌‍‌‌
    driver: bridge