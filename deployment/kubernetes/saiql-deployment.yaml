apiVersion: apps/v1
kind: Deployment
metadata:
  name: saiql-database
  labels:
    app: saiql
    version: v5.0.0
    tier: database
spec:
  replicas: 1  # Start with single instance for small scale
  selector:
    matchLabels:
      app: saiql
      tier: database
  template:
    metadata:
      labels:
        app: saiql
        tier: database
        version: v5.0.0
    spec:
      containers:
      - name: saiql
        image: saiql/database:5.0.0
        ports:
        - containerPort: 5432
          name: database
          protocol: TCP
        - containerPort: 8080
          name: metrics
          protocol: TCP
        
        # Environment variables
        env:
        - name: SAIQL_ENV
          value: "production"
        - name: SAIQL_PORT
          value: "5432"
        - name: SAIQL_HOST
          value: "0.0.0.0"
        
        # Resource limits (appropriate for small scale)
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 5432
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health
            port: 5432
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        # Volume mounts for persistent data
        volumeMounts:
        - name: saiql-data
          mountPath: /app/data
        - name: saiql-logs
          mountPath: /app/logs
        - name: saiql-config
          mountPath: /app/config
          readOnly: true
        
        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Needs write access for logs
          capabilities:
            drop:
            - ALL
      
      # Volumes
      volumes:
      - name: saiql-data
        persistentVolumeClaim:
          claimName: saiql-data-pvc
      - name: saiql-logs
        emptyDir: {}  # Logs are ephemeral in containers
      - name: saiql-config
        configMap:
          name: saiql-config
      
      # Pod security
      securityContext:
        fsGroup: 1000
      
      # Restart policy
      restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: saiql-service
  labels:
    app: saiql
    tier: database
spec:
  type: ClusterIP  # Internal service for Nova
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: database
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: metrics
  selector:
    app: saiql
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: saiql-external
  labels:
    app: saiql
    tier: database
spec:
  type: LoadBalancer  # External access if needed
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: database
  selector:
    app: saiql
    tier: database

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: saiql-data-pvc
  labels:
    app: saiql
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi  # Appropriate for small scale
  storageClassName: fast-ssd  # Use fast storage for database

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: saiql-config
  labels:
    app: saiql
data:
  production.json: |
    {
      "saiql": {
        "version": "5.0.0",
        "environment": "production",
        "debug": false,
        "log_level": "INFO"
      },
      "server": {
        "host": "0.0.0.0",
        "port": 5432,
        "workers": 2,
        "max_connections": 50,
        "connection_timeout": 30,
        "keep_alive": true
      },
      "database": {
        "data_directory": "/app/data",
        "backup_directory": "/app/backups",
        "transaction_log_directory": "/app/logs/transactions",
        "max_memory_usage_mb": 256,
        "cache_size_mb": 64,
        "enable_wal": true,
        "checkpoint_interval": 300
      },
      "performance": {
        "query_timeout": 30,
        "transaction_timeout": 60,
        "max_query_complexity": 1000,
        "enable_query_cache": true,
        "cache_ttl": 3600,
        "enable_monitoring": true,
        "metrics_collection_interval": 10
      },
      "security": {
        "enable_authentication": false,
        "enable_encryption": false,
        "max_failed_logins": 5,
        "lockout_duration": 300,
        "enable_audit_logging": true,
        "allowed_hosts": ["*"],
        "cors_origins": ["*"]
      },
      "logging": {
        "level": "INFO",
        "format": "json",
        "file_rotation_size": "100MB",
        "file_retention_days": 30,
        "enable_console": true,
        "enable_file": true,
        "log_directory": "/app/logs"
      },
      "monitoring": {
        "enable_prometheus": true,
        "prometheus_port": 8080,
        "enable_health_checks": true,
        "health_check_interval": 30,
        "enable_performance_profiling": true
      },
      "backup": {
        "enable_automatic_backup": false,
        "backup_interval": 3600,
        "retention_days": 7,
        "compression": true,
        "backup_format": "saiql_native"
      }
    }

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: saiql-service-account
  labels:
    app: saiql

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: saiql-pdb
  labels:
    app: saiql
spec:
  minAvailable: 0  # Allow disruption for single instance
  selector:
    matchLabels:
      app: saiql‍‍‍‌‍‍‌‌​‌‍‌‍‌‌‍‌​‌‍‌‍‌‌‌‌​‍‍‌‍‍‍‍‌​‍‍‌‍‍‍‍‍​‌‍‌‍‌‍‍‌​‍‍‌‌‍‍‍‌​‌‍‍‌‍‌‍‍​‌‌‌‌‌‌‌‌​‍‌‌‌‌‍‌‌
      tier: database